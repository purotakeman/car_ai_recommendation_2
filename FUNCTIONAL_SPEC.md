# AI自動車推薦システム 機能仕様書

## 1. ドキュメント情報

| 項目 | 内容 |
|------|------|
| 文書名 | 機能仕様書 |
| バージョン | 1.1 |
| 作成日 | 2025年1月 |
| 最終更新日 | 2025年12月20日 |
| 対象システム | AI自動車推薦システム |
| 関連文書 | 要件定義書.md |

---

## 2. システム概要

### 2.1 システムアーキテクチャ

```
┌─────────────┐
│  ブラウザ    │
│ (フロント)   │
└──────┬──────┘
       │ HTTP/HTTPS
       │ JSON
┌──────▼──────┐
│ Flask App   │
│ (バック)    │
└──────┬──────┘
       │
┌──────▼──────┐
│ CSV データ  │
│ (ストレージ)│
└─────────────┘
```

### 2.2 技術スタック詳細

- **バックエンド**: Flask 2.3.3 (Python 3.9+)
- **データ処理**: Pandas 2.0.3, NumPy
- **フロントエンド**: HTML5, CSS3, JavaScript (ES6+)
- **データ形式**: CSV（UTF-8, Shift-JIS, CP932対応）
- **API通信**: RESTful API（JSON形式）

---

## 3. API仕様書

### 3.1 エンドポイント一覧

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | `/` | メインページ表示 | 不要 |
| GET | `/car/<id>` | 車両詳細ページ表示 | 不要 |
| GET | `/api/cars` | 車両データ取得（フィルタリング対応） | 不要 |
| GET | `/api/cars/<id>` | 特定車両データ取得 | 不要 |
| POST | `/api/recommend` | 推薦API（AJAX用） | 不要 |
| GET | `/favorites` | お気に入りページ表示 | 不要 |
| GET | `/compare` | 車両比較ページ表示 | 不要 |

### 3.2 API詳細仕様

#### 3.2.1 GET `/api/cars`

**説明**: 車両データをJSON形式で取得する。クエリパラメータによるフィルタリングに対応。

**リクエスト**:
```
GET /api/cars?maker=トヨタ&body_type=SUV&max_price=500
```

**クエリパラメータ**:
| パラメータ | 型 | 必須 | 説明 | 例 |
|-----------|-----|------|------|-----|
| `maker` | string | 任意 | メーカー名でフィルタ | `TOYOTA` |
| `body_type` | string | 任意 | ボディタイプでフィルタ | `SUV` |
| `max_price` | float | 任意 | 上限価格でフィルタ | 5000000 |

**レスポンス**:
- **成功時 (200 OK)**:
```json
[
  {
    "id": 1,
    "メーカー": "TOYOTA",
    "車種": "プリウス",
    "自動車タイプ": "普通車",
    "ボディタイプ": "ハッチバック",
    "駆動方式": "2WD",
    "価格帯": 2769800~4608900,
    "排気量": 1986,
    "最新モデル": 2025_07,
    "グレード・モデル": "Z (PHEV)",
    "先進安全装備": "Toyota Safety Sense",
    "燃費(km/L)電費(Wh/km)水素燃費(km/kg)": 26,
    "燃料の種類": "レギュラー (PHEV)",
    "自動車税(円)": 36000,
    "乗車定員": 5,
    "中古相場(万円)": 229~799,
    "サイズ(mm)": "4600×1780×1430"
  }
]
```

- **エラー時**: エラーレスポンスなし（空配列を返す）

**実装詳細**:
- フィルタリングはAND条件で適用
- 価格フィルタは価格帯の最小値と比較
- データが存在しない場合は空配列を返す

---

#### 3.2.2 GET `/api/cars/<id>`

**説明**: 特定の車両IDの詳細情報を取得する。

**リクエスト**:
```
GET /api/cars/170
```

**パスパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| `id` | integer | 必須 | 車両ID |

**レスポンス**:
- **成功時 (200 OK)**:
```json
{
  "id": 170,
  "メーカー": "トヨタ",
  "車種": "プリウス",
  "ボディタイプ": "ハッチバック",
  "価格帯": 2769800~4608900,
  "燃費(km/L)": 26,
  "燃料の種類": "レギュラー (PHEV)",
  "推薦スコア": 85,
  "詳細スコア": {
    "price": 75,
    "fuel_economy": 90,
    "size": 60,
    "safety": 80,
    "maintenance": 70,
    "brand": 85,
    "environmental": 85,
    "purpose_fit": 75
  },
  "推薦理由": "優れた燃費性能（26km/L）で経済的です、メーカー独自の安全装備を搭載しており、安心して運転できます"
}
```

- **エラー時 (404 Not Found)**:
```json
{
  "error": "車両情報が見つかりません"
}
```

---

#### 3.2.3 POST `/api/recommend`

**説明**: ユーザーの嗜好情報に基づいて車両を推薦する。ハイブリッド診断と簡単診断の両方に対応。

**リクエスト**:
```
POST /api/recommend
Content-Type: application/json
```

**リクエストボディ（ハイブリッド診断の場合）**:
```json
{
  "user_profile": "family",
  "purpose": "family",
  "experience_level": "beginner",
  "fuel_economy_importance": 0.6,
  "safety_importance": 0.8,
  "design_importance": 0.4,
  "space_importance": 0.9,
  "maintenance_importance": 0.7,
  "max_price": "400",
  "min_seats": "5",
  "preferred_size": "large",
  "body_types": ["ミニバン", "SUV"],
  "fuel_types": ["ハイブリッド", "ガソリン"]
}
```

**リクエストボディ（簡単診断の場合）**:
```json
{
  "purpose": "family",
  "priority": "safety",
  "budget_range": "medium",
  "experience_level": "beginner"
}
```

**リクエストパラメータ詳細**:

| パラメータ | 型 | 必須 | 説明 | 値の範囲 |
|-----------|-----|------|------|---------|
| `user_profile` | string | ハイブリッド診断時 | ユーザープロファイル | `family`, `commuter`, `luxury`, `eco`, `balance` |
| `purpose` | string | 任意 | 主な用途 | `family`, `commute`, `leisure`, `business` |
| `experience_level` | string | 任意 | 経験レベル | `beginner`, `intermediate`, `expert` |
| `fuel_economy_importance` | float | 任意 | 燃費重要度 | 0.0-1.0 |
| `safety_importance` | float | 任意 | 安全性重要度 | 0.0-1.0 |
| `design_importance` | float | 任意 | デザイン重要度 | 0.0-1.0 |
| `space_importance` | float | 任意 | 室内空間重要度 | 0.0-1.0 |
| `maintenance_importance` | float | 任意 | 維持費重要度 | 0.0-1.0 |
| `max_price` | string | 任意 | 上限価格 | 数値文字列 |
| `min_seats` | string | 任意 | 最小乗車定員 | 数値文字列 |
| `preferred_size` | string | 任意 | 希望サイズ | `small`, `medium`, `large` |
| `body_types` | array | 任意 | 希望ボディタイプ | 文字列配列 |
| `fuel_types` | array | 任意 | 希望燃料タイプ | 文字列配列 |
| `min_fuel_economy` | string | 任意 | 最小燃費（km/L） | 数値文字列 |

**レスポンス**:
- **成功時 (200 OK)**:
```json
{
  "success": true,
  "cars": [
    {
      "id": 1,
      "メーカー": "トヨタ",
      "車種": "プリウス",
      "推薦スコア": 85,
      "詳細スコア": {
        "price": 75,
        "fuel_economy": 90,
        "size": 60,
        "safety": 80,
        "maintenance": 70,
        "brand": 85,
        "environmental": 85,
        "purpose_fit": 75
      },
      "推薦理由": "優れた燃費性能（32.6km/L）で経済的です、メーカー独自の安全装備を搭載しており、安心して運転できます"
    }
  ],
  "total": 15,
  "user_profile": "family",
  "diagnosis_type": "hybrid",
  "analysis": {
    "profile_confidence": 0.75,
    "top_factors": [
      {
        "name": "安全性",
        "description": "家族を守る充実した安全装備",
        "importance": 0.8
      },
      {
        "name": "室内空間",
        "description": "ゆったりとした快適な車内空間",
        "importance": 0.9
      }
    ],
    "alternative_profiles": [
      {
        "profile": "balance",
        "name": "バランス重視タイプ",
        "characteristics": ["バランス重視", "汎用性", "無難な選択"]
      }
    ]
  }
}
```

- **エラー時 (400 Bad Request)**:
```json
{
  "success": false,
  "error": "リクエストデータが空です",
  "diagnosis_type": "unknown"
}
```

- **エラー時 (500 Internal Server Error)**:
```json
{
  "success": false,
  "error": "推薦計算でエラーが発生しました: ...",
  "diagnosis_type": "unknown"
}
```

**実装詳細**:
- ハイブリッド診断の場合は`user_profile`が含まれる
- 推薦スコアは0-100の整数で返される
- 上位10台まで返される
- ハイブリッド診断の場合は分析情報も含まれる

---

## 4. データモデル仕様書

### 4.1 車両データモデル

**テーブル名**: `cars` (CSV形式)

**カラム定義**:

| カラム名 | 型 | 必須 | 説明 | 例 |
|---------|-----|------|------|-----|
| `id` | integer | 必須 | 車両ID（一意） | `1` |
| `メーカー` | string | 必須 | メーカー名 | `トヨタ` |
| `車種` | string | 必須 | 車種名 | `プリウス` |
| `自動車タイプ` | string | 必須 | 普通車/軽自動車 | `普通車` |
| `ボディタイプ` | string | 必須 | ボディタイプ | `ハッチバック` |
| `駆動方式` | string | 必須 | 2WD/4WD | `2WD` |
| `価格帯` | string | 必須 | 価格範囲 | `2769800~4608900` |
| `排気量` | float | 任意 | 排気量（cc） | `1986` |
| `最新モデル` | integer | 任意 | 最新モデル | `2025_07` |
| `グレード・モデル` | string | 任意 | グレード・モデル名 | `Z (PHEV)` |
| `先進安全装備` | string | 任意 | 各メーカー標準安全装備名 | `Toyota Safety Sense` |
| `燃費(km/L)` | float | 任意 | 燃費 | `26` |
| `燃料の種類` | string | 必須 | 燃料タイプ | `レギュラー (PHEV)` |
| `自動車税(円)` | integer | 任意 | 年間自動車税 | `36000` |
| `乗車定員` | integer | 任意 | 乗車定員数 | `5` |
| `中古相場(万円)` | float | 任意 | 中古相場価格 | `229~799` |
| `サイズ(mm)` | string | 任意 | 全長×全幅×全高 | `4610×1775×1490` |

**データ型の詳細**:
- `価格帯`: "最小値~最大値" 形式（例: "2769800~4608900"）
- `サイズ(mm)`: "全長×全幅×全高" 形式（例: "4610×1775×1490"）
- 欠損値は空文字列または`NaN`として扱う

**データ品質要件**:
- 数値データは`pd.to_numeric()`で変換、エラー時は`NaN`
- 文字列データは空の場合は`'未定'`で埋める
- 先進安全装備が未設定の場合は`'NO'`または空文字列
- 燃費・排気量のデフォルト値: `0`

---

### 4.2 推薦スコアデータモデル

**計算される追加フィールド**:

| フィールド名 | 型 | 説明 | 範囲 |
|------------|-----|------|------|
| `推薦スコア` | integer | 最終推薦スコア | 0-100 |
| `詳細スコア` | object | 各評価項目のスコア | 各項目0-100 |
| `推薦理由` | string | 推薦理由（最大3つ） | 文字列 |

**詳細スコアの構造**:
```json
{
  "price": 75,
  "fuel_economy": 90,
  "size": 60,
  "safety": 80,
  "maintenance": 70,
  "brand": 85,
  "environmental": 85,
  "purpose_fit": 75
}
```

---

## 5. UI/UX仕様書

### 5.1 画面一覧

| 画面ID | 画面名 | URL | 説明 |
|--------|--------|-----|------|
| SCREEN_001 | メインページ | `/` | 検索・診断機能のトップページ |
| SCREEN_002 | 車両詳細ページ | `/car/<id>` | 車両の詳細情報表示 |
| SCREEN_003 | お気に入りページ | `/favorites` | お気に入り車両一覧（将来実装） |
| SCREEN_004 | 車両比較ページ | `/compare?ids=1,2,3` | 複数車両の比較表示 |
| SCREEN_005 | 404エラーページ | - | ページが見つからない場合 |
| SCREEN_006 | 500エラーページ | - | サーバーエラー時 |

---

### 5.2 画面遷移図

```
[SCREEN_001: メインページ]
    │
    ├─→ [ハイブリッド診断実行] ─→ [SCREEN_001: 検索結果表示]
    │
    ├─→ [詳細検索実行] ─→ [SCREEN_001: 検索結果表示]
    │
    ├─→ [車両カードクリック] ─→ [SCREEN_002: 車両詳細ページ]
    │
    ├─→ [お気に入りリンク] ─→ [SCREEN_003: お気に入りページ]
    │
    └─→ [比較リンク] ─→ [SCREEN_004: 車両比較ページ]

[SCREEN_002: 車両詳細ページ]
    │
    ├─→ [関連車両クリック] ─→ [SCREEN_002: 車両詳細ページ（別車両）]
    │
    └─→ [トップページに戻る] ─→ [SCREEN_001: メインページ]
```

---

### 5.3 画面詳細仕様

#### 5.3.1 SCREEN_001: メインページ

**レイアウト構成**:
```
┌─────────────────────────────────────┐
│ ヘッダー                            │
│ - ロゴ・タイトル                    │
│ - ナビゲーションメニュー            │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 検索セクション                      │
│ ┌───────────────────────────────┐  │
│ │ ハイブリッド診断モード         │  │
│ │ - ステップ1: 基本情報          │  │
│ │ - ステップ2: 重視ポイント      │  │
│ │ - ステップ3: 診断結果          │  │
│ └───────────────────────────────┘  │
│ ┌───────────────────────────────┐  │
│ │ 詳細検索フォーム（非表示）     │  │
│ │ - ボディタイプ                 │  │
│ │ - 駆動方式                     │  │
│ │ - 燃料タイプ                   │  │
│ │ - 価格・燃費・定員             │  │
│ └───────────────────────────────┘  │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ AI分析結果（検索後表示）            │
│ - 検索結果数                       │
│ - 推薦理由                         │
│ - 平均予算                         │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 検索結果セクション                  │
│ - 並び替えオプション                │
│ - 車両カード一覧                   │
│ - ページネーション                  │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ フッター                            │
└─────────────────────────────────────┘
```

**主要コンポーネント**:

1. **ハイブリッド診断モード**
   - プログレスバー（進捗表示）
   - ステップ1: 基本情報（選択肢形式）
     - 主な用途（4択）
     - 予算帯（4択）
     - 乗車人数（3択）
   - ステップ2: 重視ポイント（5段階評価）
     - 燃費の良さ
     - 安全性
     - デザインの良さ
     - 広い室内空間
     - 維持費の安さ
   - ステップ3: 診断結果
     - ユーザープロファイル表示
     - 推薦理由表示
     - 「あなたに最適な車を見る」ボタン
   - ナビゲーションボタン（前へ/次へ）

2. **詳細検索フォーム**
   - ボディタイプ（チェックボックス、複数選択可）
   - 駆動方式（チェックボックス、複数選択可）
   - 燃料タイプ（チェックボックス、複数選択可）
   - 上限価格（数値入力）
   - 燃費下限（数値入力）
   - 乗車定員下限（数値入力）
   - 検索ボタン、リセットボタン

3. **検索結果表示**
   - 並び替えセレクトボックス
     - 推薦順
     - 価格: 安い順
     - 価格: 高い順
     - 燃費: 良い順
   - 車両カード（各車両）
     - メーカー・車種
     - 推薦スコアバッジ
     - 基本情報（タイプ、駆動、価格、燃費など）
     - 推薦理由
     - 詳細ボタン、お気に入りボタン

**インタラクション**:
- モード切り替えボタンでハイブリッド診断⇔詳細検索を切り替え
- ハイブリッド診断の各ステップでバリデーション
- 検索結果はAJAXで非同期取得
- ローディングアニメーション表示

---

#### 5.3.2 SCREEN_002: 車両詳細ページ

**レイアウト構成**:
```
┌─────────────────────────────────────┐
│ ヘッダー                            │
│ - 戻るリンク                        │
│ - ナビゲーションメニュー            │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 車両ヘッダー                        │
│ - メーカー・車種名                  │
│ - お気に入り・シェアボタン          │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 車両概要                            │
│ - 車両画像（プレースホルダー）      │
│ - 基本情報サマリー                  │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 特徴と評価                          │
│ - 長所リスト                        │
│ - 注意点リスト                      │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 総評                                │
│ - 総評テキスト                      │
│ - 推薦スコア表示                    │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ タブセクション                      │
│ [詳細スペック]　　　　　　　[レビュー]│
│ - 詳細スペックテーブル              │
│ - レビュー一覧                      │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 関連車両                            │
│ - 関連車両カード（最大5台）         │
└─────────────────────────────────────┘
```

**主要コンポーネント**:

1. **車両概要セクション**
   - 新車価格、中古相場
   - ボディタイプ、駆動方式
   - 燃費、燃料タイプ
   - 乗車定員、自動車税
   - サイズ

2. **特徴と評価セクション**
   - 長所リスト（ボディタイプ・駆動方式・燃料タイプに基づく）
   - 注意点リスト（同上）

3. **タブセクション**
   - **詳細スペックタブ**: 全項目の詳細テーブル
   - **レビュー・評価タブ**: レビュー一覧（現在は固定データ）

4. **関連車両セクション**
   - 同じボディタイプまたはメーカーの車両（最大5台）
   - 各車両の基本情報と詳細リンク

**インタラクション**:
- タブ切り替えでコンテンツ表示切り替え
- お気に入りボタンでローカルストレージに保存
- シェアボタン（将来実装）

---

#### 5.3.3 SCREEN_004: 車両比較ページ

**レイアウト構成**:
```
┌─────────────────────────────────────┐
│ ヘッダー                            │
└─────────────────────────────────────┘
┌─────────────────────────────────────┐
│ 比較表                              │
│ - 車両カード一覧（横並び）          │
│ - 比較項目テーブル                  │
└─────────────────────────────────────┘
```

**主要コンポーネント**:
- 比較対象車両のカード表示
- 比較項目の並列表

**URLパラメータ**:
- `ids`: 比較対象の車両ID（カンマ区切り）
  - 例: `/compare?ids=1,2,3`

---

### 5.4 UIコンポーネント仕様

#### 5.4.1 車両カード

**構造**:
```html
<div class="car-card">
  <div class="car-header">
    <h3>メーカー 車種</h3>
    <div class="score-badge">推薦スコア</div>
  </div>
  <div class="car-body">
    <div class="car-info">
      <!-- 基本情報 -->
    </div>
    <div class="car-actions">
      <a href="/car/{id}">詳細</a>
      <button class="favorite-button">お気に入り</button>
    </div>
  </div>
</div>
```

**表示項目**:
- メーカー・車種名
- 推薦スコアバッジ（スコアがある場合）
- ボディタイプ、駆動方式
- 価格帯、燃費
- 燃料の種類、乗車定員
- サイズ（ある場合）
- 中古相場、自動車税（ある場合）
- 推薦理由（ある場合）

---

#### 5.4.2 プログレスバー

**構造**:
```html
<div class="diagnosis-progress">
  <div class="progress-bar">
    <div class="progress-fill" style="width: 33%"></div>
  </div>
  <div class="progress-text">
    <span>基本情報</span> (1 / 3)
  </div>
</div>
```

**動作**:
- 現在のステップ数に応じて進捗率を計算
- ステップ名とカウンターを表示

---

#### 5.4.3 選択肢カード（ハイブリッド診断）

**構造**:
```html
<label class="choice-card">
  <input type="radio" name="hybrid_purpose" value="family">
  <div class="choice-content">
    <i class="fas fa-home choice-icon"></i>
    <span class="choice-text">家族での外出</span>
    <small class="choice-desc">お子様の送迎、家族旅行など</small>
  </div>
</label>
```

**動作**:
- クリックで選択状態になる
- 選択時に`selected`クラスが追加される
- アニメーション効果（scale 0.95 → 1.0）

---

#### 5.4.4 5段階評価（ハイブリッド診断）

**構造**:
```html
<div class="rating-question">
  <div class="rating-header">
    <i class="fas fa-gas-pump rating-icon"></i>
    <div class="rating-title">燃費の良さ</div>
  </div>
  <div class="rating-description">説明文</div>
  <div class="rating-scale">
    <div class="scale-labels">
      <span>全く重要でない</span>
      <span>とても重要</span>
    </div>
    <div class="rating-options">
      <label class="rating-option">
        <input type="radio" name="hybrid_fuel_importance" value="1">
        <span class="rating-number">1</span>
      </label>
      <!-- 2-5も同様 -->
    </div>
  </div>
</div>
```

**動作**:
- 1-5の数値で評価
- 選択時に`selected`クラスが追加される
- アニメーション効果

---

## 6. 推薦アルゴリズム仕様書

### 6.1 推薦エンジン概要

**クラス名**: `EnhancedCarRecommendationEngine`

**処理フロー**:
```
1. ユーザー嗜好データ受信
2. ユーザープロファイル判定
3. 各車両の詳細スコア計算
4. 重み付け最終スコア計算
5. 推薦理由生成
6. スコア順にソート
7. 結果返却
```

---

### 6.2 ユーザープロファイル判定仕様

**判定ロジック**:

1. **事実情報によるスコアリング**
   - 用途（`purpose`）: 各プロファイルにスコア加算
   - 予算（`budget`）: 予算帯に応じてスコア加算
   - 乗車人数（`passengers`）: 人数に応じてスコア加算

2. **嗜好情報によるスコアリング**
   - 燃費重要度: 4以上で`eco`+25, `commuter`+20
   - 安全性重要度: 4以上で`family`+25, `balance`+15
   - デザイン重要度: 4以上で`luxury`+30
   - 室内空間重要度: 4以上で`family`+25
   - 維持費重要度: 4以上で`commuter`+25, `eco`+15

3. **プロファイル選択**
   - 各プロファイルのスコアを合計
   - 最高スコアのプロファイルを選択
   - 最低しきい値（40点）未満の場合は`general`（汎用）を返す

**プロファイル定義**:

| プロファイル | 優先度設定 | 希望ボディタイプ | その他条件 |
|------------|-----------|----------------|-----------|
| `family` | 安全性25%、室内空間20%、燃費20%、価格15%、信頼性10% | ミニバン、SUV、ハッチバック | 最小乗車定員5人 |
| `commuter` | 燃費30%、価格25%、維持費20%、サイズ15%、信頼性10% | ハッチバック、軽自動車、セダン | 上限価格300000 |
| `luxury` | 快適性25%、性能20%、ブランド20%、安全性15%、デザイン20% | セダン、SUV、オープンカー | 最小価格400000 |
| `eco` | 燃費35%、環境性能25%、価格20%、維持費20% | - | 希望燃料: HEV、EV、PHEV |
| `sporty` | 性能30%、デザイン25%、ハンドリング20%、ブランド15%、個性10% | オープンカー、ハッチバック、セダン | - |
| `general` | 均等重み（各20%） | - | - |

---

### 6.3 詳細スコア計算仕様

#### 6.3.1 価格スコア計算

**計算式**:
```
if price == 0:
    return 50  # 価格不明

if price <= max_price:
    ratio = price / max_price
    score = 100 * (1 - ratio * 0.8)  # 80%まで減点
else:
    over_ratio = (price - max_price) / max_price
    score = max(0, 50 - over_ratio * 100)  # 予算超過で大幅減点
```

**範囲**: 0-100

---

#### 6.3.2 燃費スコア計算

**計算式**:
```
if fuel_type == 'EV':
    return 95  # EVは特別に高評価
elif fuel_type in ['ハイブリッド', 'PHEV']:
    base_score = min(100, fuel_economy * 4)  # 25km/L以上で満点
else:
    base_score = min(100, fuel_economy * 5)  # 20km/L以上で満点

return max(10, base_score)
```

**範囲**: 10-100

---

#### 6.3.3 サイズ適合度スコア計算

**計算式**:
```
# サイズから全長を抽出（正規表現）
length = extract_length(size_str)

# 希望サイズ別の理想値と範囲
size_preferences = {
    'small': {'ideal': 3800, 'range': 600},   # 軽自動車・コンパクト
    'medium': {'ideal': 4500, 'range': 700},  # ミドルサイズ
    'large': {'ideal': 5000, 'range': 800}    # 大型車
}

distance = abs(length - ideal)
if distance <= range:
    score = 100 - (distance / range) * 50
else:
    score = max(0, 50 - (distance - range) / 200)
```

**範囲**: 0-100

---

#### 6.3.4 安全性スコア計算

**計算式**:
```python
# 安全装備のスコアマッピング（Tier制）
SAFETY_EQUIPMENT_SCORES = {
    # Tier 1 (95-100): 最先端・高度な安全装備
    'アイサイトX': 100,
    'HONDA SENSING360+': 100,
    'HONDA SENSING360': 98,
    '360°セーフティアシスト': 95,
    
    # Tier 2 (85-90): 標準的な先進安全装備
    'アイサイト': 90,
    'HONDA SENSING': 90,
    'Toyota Safety Sense': 90,
    'SUBARU Safety Sense': 90,
    'i-ACTIVSENSE': 88,
    'e-Assist': 85,
    'スマートアシスト': 85,
    
    # Tier 3 (40-50): 装備なし・その他
    'NO': 40,
    '': 50
}

# メーカー別安全信頼度スコア（0-100）
maker_safety_scores = {
    'SUBARU': 95,
    'VOLVO': 95,
    'TOYOTA': 90,
    'HONDA': 90,
    'MAZDA': 88,
    'NISSAN': 85,
    'MITSUBISHI': 85,
    'SUZUKI': 80,
    'DAIHATSU': 80,
    # その他: 75
}

# 最終スコア = 装備評価(70%) + メーカー信頼度(30%)
# 装備の性能と有無をより重視する設計
final_score = int(equipment_score * 0.7 + maker_score * 0.3)
```

**範囲**: 0-100

**Tier定義**:
- **Tier 1 (95-100点)**: アイサイトX, HONDA SENSING360+ など、最先端の運転支援機能を備えたもの。
- **Tier 2 (85-90点)**: アイサイト, Toyota Safety Sense, スマートアシストなど、標準的な衝突被害軽減ブレーキや運転支援機能を備えたもの。
- **Tier 3 (40-50点)**: 先進安全装備がない、または不明なもの。

**メーカー信頼度**:
メーカーごとの安全思想や実績に基づき、ベースとなる信頼度スコアを加算します。

---

#### 6.3.5 維持費スコア計算

**計算式**:
```
tax = car.get('自動車税(円)', 50000)
displacement = car.get('排気量', 1500)
fuel_type = car.get('燃料の種類', 'ガソリン')

tax_score = max(0, 100 - tax / 1000)  # 安いほど高スコア
displacement_score = max(0, 100 - displacement / 50)  # 小さいほど高スコア

fuel_bonus = {
    'EV': 20,
    'ハイブリッド': 15,
    'PHEV': 10,
    'ガソリン': 0,
    'ディーゼル': 5
}

final_score = (tax_score + displacement_score) / 2 + fuel_bonus.get(fuel_type, 0)
return max(0, min(100, final_score))
```

**範囲**: 0-100

---

#### 6.3.6 ブランド信頼性スコア計算

**ブランド階層定義**:
```python
brand_tiers = {
    'premium': ['レクサス', 'メルセデス・ベンツ', 'BMW', 'アウディ', 'ボルボ'],
    'mainstream': ['トヨタ', 'ホンダ', '日産', 'マツダ', 'スバル'],
    'value': ['ダイハツ', 'スズキ', '三菱'],
    'specialty': ['テスラ', 'ポルシェ', 'フェラーリ']
}
```

**計算式**:
```
if maker in brand_tiers['premium']:
    return 95
elif maker in brand_tiers['mainstream']:
    return 85
elif maker in brand_tiers['value']:
    return 75
elif maker in brand_tiers['specialty']:
    return 90
else:
    return 70  # 不明ブランドのデフォルト
```

**範囲**: 70-95

---

#### 6.3.7 環境性能スコア計算

**計算式**:
```
fuel_type = car.get('燃料の種類', 'ガソリン')
fuel_economy = car.get('燃費(km/L)', 15)

base_scores = {
    'EV': 100,
    'PHEV': 85,
    'ハイブリッド': 80,
    'ディーゼル': 60,
    'ガソリン': 40
}

base_score = base_scores.get(fuel_type, 40)

if fuel_type != 'EV':
    fuel_bonus = min(20, (fuel_economy - 10) * 2)
    base_score += fuel_bonus

return max(0, min(100, base_score))
```

**範囲**: 0-100

---

#### 6.3.8 用途適合度スコア計算

**計算式**:
```
score = 50  # 基本点

# ボディタイプ適合度
if body_type in preferred_body_types:
    score += 30

# 乗車定員チェック
if seats >= min_seats:
    score += 10

# 価格帯チェック
if min_price <= price <= max_price:
    score += 15

# 燃料タイプチェック
if fuel_type in preferred_fuel_types:
    score += 20

return max(0, min(100, score))
```

**範囲**: 0-100

---

### 6.4 重み付け最終スコア計算仕様

**計算式**:
```
# プロファイル別の重み設定
if user_profile == 'general':
    weights = {
        'price': 0.2,
        'fuel_economy': 0.2,
        'size': 0.15,
        'safety': 0.15,
        'maintenance': 0.15,
        'brand': 0.1,
        'environmental': 0.05
    }
else:
    weights = {
        'price': profile_priorities.get('price', 0.1),
        'fuel_economy': profile_priorities.get('fuel_economy', 0.1),
        'size': profile_priorities.get('size', 0.1),
        'safety': profile_priorities.get('safety', 0.1),
        'maintenance': profile_priorities.get('maintenance', 0.1),
        'brand': profile_priorities.get('brand', 0.1),
        'environmental': profile_priorities.get('environmental', 0.1),
        'purpose_fit': 0.3  # 用途適合度は常に重要
    }

final_score = 0
total_weight = 0

for factor, weight in weights.items():
    if factor in detailed_scores:
        final_score += detailed_scores[factor] * weight
        total_weight += weight

# 正規化
if total_weight > 0:
    final_score = final_score / total_weight

return max(0, min(100, int(final_score)))
```

**範囲**: 0-100（整数）

---

### 6.5 推薦理由生成仕様

**生成ロジック**:
1. 詳細スコアが80以上の要因を特定
2. 各要因に基づいて推薦理由を生成
3. 最大3つの理由を結合

**推薦理由テンプレート**:

| 要因 | スコア条件 | 理由テンプレート |
|------|-----------|----------------|
| `fuel_economy` | >= 80 | "優れた燃費性能（{fuel_economy}km/L）で経済的です" |
| `safety` | >= 80 | "メーカーの高い安全基準と先進安全装備により、安心して運転できます" |
| `maintenance` | >= 80 | "維持費が安く、年間の自動車税も抑えられます" |
| `brand` | >= 80 | "プレミアムブランドならではの品質と信頼性があります" |
| `purpose_fit` | >= 80 | プロファイル別の理由 |

**プロファイル別理由**:
- `family`: "ファミリー用途に最適な装備と空間を備えています"
- `commuter`: "通勤利用に適したコンパクトサイズと経済性を兼ね備えています"
- `eco`: "環境性能に優れ、エコ志向の方におすすめです"

**デフォルト理由**:
- 高得点要因がない場合: "総合的にバランスの取れた良い車です"

---

## 7. エラーハンドリング仕様

### 7.1 エラー種別

| エラーコード | HTTPステータス | 説明 | 処理 |
|------------|---------------|------|------|
| 400 | Bad Request | リクエストデータが不正 | エラーメッセージを返す |
| 404 | Not Found | リソースが見つからない | 404エラーページ表示 |
| 500 | Internal Server Error | サーバー内部エラー | 500エラーページ表示 |

### 7.2 エラーレスポンス形式

**APIエラー時**:
```json
{
  "success": false,
  "error": "エラーメッセージ",
  "diagnosis_type": "unknown"
}
```

**ページエラー時**:
- 404エラー: `templates/404.html`を表示
- 500エラー: `templates/500.html`を表示

### 7.3 データ欠損時の処理

**数値データ**:
- 変換エラー時: `NaN`に変換後、デフォルト値で埋める
- 燃費・排気量: デフォルト値 `0`

**文字列データ**:
- 空文字列: `'未定'`で埋める
- ボディタイプ・駆動方式: `'不明'`で埋める
- 燃料の種類: `'ガソリン'`で埋める

---

## 8. パフォーマンス仕様

### 8.1 応答時間目標

| 処理 | 目標時間 | 最大許容時間 |
|------|---------|-------------|
| ページ読み込み | 1秒以内 | 3秒 |
| API応答 | 500ms以内 | 1秒 |
| 検索結果表示 | 1秒以内 | 2秒 |
| 推薦計算 | 500ms以内 | 1秒 |

### 8.2 データ量制限

- 検索結果表示: 上位10台まで（API）
- 関連車両表示: 最大5台
- 推薦理由: 最大3つ

---

## 9. セキュリティ仕様

### 9.1 入力値検証

- 数値入力: 型チェック、範囲チェック
- 文字列入力: サニタイゼーション（将来実装）
- SQLインジェクション対策: パラメータ化クエリ（将来データベース移行時）

### 9.2 XSS対策

- テンプレートエンジン（Jinja2）の自動エスケープ機能を使用
- ユーザー入力値は必ずエスケープ処理

### 9.3 CSRF対策

- 現在は未実装（将来実装予定）

---

## 10. テスト仕様（将来実装）

### 10.1 単体テスト

- 推薦スコア計算のテスト
- フィルタリング機能のテスト
- プロファイル判定のテスト
- データ変換処理のテスト

### 10.2 統合テスト

- APIエンドポイントのテスト
- フロントエンド・バックエンド連携テスト
- エラーハンドリングのテスト

### 10.3 E2Eテスト

- ハイブリッド診断のフロー全体テスト
- 詳細検索のフロー全体テスト
- 車両詳細表示のテスト

---

## 11. 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|-----------|---------|--------|
| 2025-01-XX | 1.0 | 初版作成 | - |

---

## 12. 参考資料

- 要件定義書.md
- README.md
- ソースコード（app.py, utils/recommendation.py, static/js/*.js）

---

**文書作成日**: 2025年1月
**最終更新日**: 2025年1月
**バージョン**: 1.0

