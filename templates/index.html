<!DOCTYPE html>
<!-- ブラウザにHTML5の仕様に従って作ったページをレンダリングするように指示する。古いブラウザの互換モードで表示 -->
<html lang="ja">
<!-- このWebページが日本語で書かれていることをブラウザや検索エンジンに伝えるHTML属性 -->

<head>
    <meta charset="UTF-8">
    <meta charset="UTF-8"><!-- 文字エンコードの指定。世界中の文字を表示できる標準的な文字コード  -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- レスポンシブデザインのための設定。Webサイトをさまざまなデバイスで表示できるようになる  -->
    <meta name="description" content="AI技術であなたに最適な車を推薦。ライフスタイルや予算に合わせたカーライフをサポートします。">
    <!-- description(説明文)は、Googleなどの検索結果に表示される説明文。  -->
    <meta name="keywords" content="車選び,AI推薦,自動車診断,最適な車,車探し">
    <!-- keywordはこのページが何について書かれているか検索エンジンに伝える。現在はSEO効果は限定的だが、ページ内容の整理に役立つ -->
    <meta name="robots" content="index, follow">
    <!-- robotsは検索エンジンのクローラー(ボット)に対する指示
        	index:このページを検索結果に表示してもいい
            follow：このページのリンク先も巡回してもいい
         -->
    <meta property="og:title" content="AI自動車診断 - あなたに最適な車を見つけましょう">
    <meta property="og:description" content="AI技術であなたに最適な車を推薦。ライフスタイルや予算に合わせたカーライフをサポートします。">
    <meta property="og:type" content="website">
    <!--OGP(Open Graph Protocol)はfacebookやXなどのSNSでシェアされたときに表示される情報を制御する。
        	og:title：SNSで表示されるタイトル
            og:description：SNSで表示される説明文
            og:type：コンテンツの種類(この場合はWebサイト)
        -->
    <!-- metaタグを使う理由
    	1.SEO対策：検索エンジンにページの内容を伝える
        2.ユーザビリティ：適切な文字コードや表示設定でユーザーが快適に閲覧できる
        3.SNS対策：シェアされた時に魅力的に表示される
        4.アクセシビティ：様々なデバイスや環境で正しく表示される
     -->
    <title>AI自動車診断 - あなたに最適な車を見つけましょう</title>
    <!-- titleは、ブラウザのタブに表示される文字で検索結果でも最も目立つ部分。SEOにとって有効 -->

    <!-- CSSファイルの読み込み（既存のファイル構造を使用） -->
    <!-- 外部リソースの読み込み（既存のファイル構造を使用） -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- CSS(スタイルシート)の読み込み
        	url_for() は Flask(Pythonのウェブフレームワーク)の記法で、静的ファイルへのパスを自動生成している
         -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hybrid.css') }}">
    <!-- FontAwesomeアイコン -->
    <!-- Font Awesomeというアイコンライブラリを読み込んでいる。 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- ファビコン -->
    <!-- ファビコン(ブラウザのタブに表示される小さなアイコン)の設定 -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
</head>

<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-car"></i> AI自動車診断システム</h1>
            <p class="tagline">あなたにピッタリの車を見つけます</p>
            <nav class="main-nav">
                <a href="{{ url_for('home') }}" class="nav-link"><i class="fas fa-home"></i> トップ</a>
                <a href="{{ url_for('favorites') }}" class="nav-link"><i class="far fa-heart"></i> お気に入り</a>
                <a href="{{ url_for('compare_cars') }}" class="nav-link"><i class="fas fa-balance-scale"></i> 比較</a>
            </nav>
        </header>

        <div class="search-section" id="search-form">
            <h2><i class="fas fa-search"></i> あなたにピッタリの車を見つけましょう</h2>

            <!-- ハイブリッド診断モード -->
            <div class="hybrid-diagnosis-mode" id="hybrid-diagnosis-mode">
                <div class="diagnosis-header">
                    <h3><i class="fas fa-brain"></i> スマート診断（おすすめ）</h3>
                    <p class="diagnosis-subtitle">段階的な質問で、より精密にあなたに最適な車を見つけます</p>

                    <!-- プログレスバー -->
                    <div class="diagnosis-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="diagnosisProgressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="currentStepText">基本情報</span>
                            (<span id="stepCounter">1</span> / <span id="totalSteps">3</span>)
                        </div>
                    </div>
                </div>

                <!-- ステップ1: 事実情報（選択肢形式） -->
                <div class="diagnosis-step active" id="diagnosis-step-1">
                    <h4 class="step-title">基本情報をお聞かせください</h4>

                    <div class="question-group">
                        <label class="question-title">
                            <i class="fas fa-route"></i> 主な用途は何ですか？
                        </label>
                        <p class="question-subtitle">最も多く使う場面を選択してください</p>
                        <div class="choice-grid">
                            <label class="choice-card">
                                <input type="radio" name="hybrid_purpose" value="family">
                                <div class="choice-content">
                                    <i class="fas fa-home choice-icon"></i>
                                    <span class="choice-text">家族での外出</span>
                                    <small class="choice-desc">お子様の送迎、家族旅行など</small>
                                </div>
                            </label>
                            <label class="choice-card">
                                <input type="radio" name="hybrid_purpose" value="commute">
                                <div class="choice-content">
                                    <i class="fas fa-briefcase choice-icon"></i>
                                    <span class="choice-text">通勤・通学</span>
                                    <small class="choice-desc">毎日の移動手段として</small>
                                </div>
                            </label>
                            <label class="choice-card">
                                <input type="radio" name="hybrid_purpose" value="leisure">
                                <div class="choice-content">
                                    <i class="fas fa-mountain choice-icon"></i>
                                    <span class="choice-text">レジャー・趣味</span>
                                    <small class="choice-desc">アウトドア、ドライブなど</small>
                                </div>
                            </label>
                            <label class="choice-card">
                                <input type="radio" name="hybrid_purpose" value="business">
                                <div class="choice-content">
                                    <i class="fas fa-building choice-icon"></i>
                                    <span class="choice-text">仕事・営業</span>
                                    <small class="choice-desc">商談、配達、営業活動</small>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="question-group">
                        <label class="question-title">
                            <i class="fas fa-yen-sign"></i> ご予算はどの程度ですか？
                        </label>
                        <p class="question-subtitle">新車購入時の予算をお選びください</p>
                        <div class="choice-grid">
                            <label class="choice-card">
                                <input type="radio" name="hybrid_budget" value="low">
                                <div class="choice-content">
                                    <i class="fas fa-coins choice-icon"></i>
                                    <span class="choice-text">〜200万円</span>
                                    <small class="choice-desc">コストパフォーマンス重視</small>
                                </div>
                            </label>
                            <label class="choice-card">
                                <input type="radio" name="hybrid_budget" value="medium">
                                <div class="choice-content">
                                    <i class="fas fa-money-bill-wave choice-icon"></i>
                                    <span class="choice-text">200〜500万円</span>
                                    <small class="choice-desc">バランス重視</small>
                                </div>
                            </label>
                            <label class="choice-card">
                                <input type="radio" name="hybrid_budget" value="high">
                                <div class="choice-content">
                                    <i class="fas fa-gem choice-icon"></i>
                                    <span class="choice-text">500万円〜</span>
                                    <small class="choice-desc">品質・装備重視</small>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="question-group">
                        <label class="question-title">
                            <i class="fas fa-users"></i> 普段何人で乗ることが多いですか？
                        </label>
                        <p class="question-subtitle">最も頻繁な乗車人数を選択してください</p>
                        <div class="choice-grid">
                            <label class="choice-card">
                                <input type="radio" name="hybrid_passengers" value="1-2">
                                <div class="choice-content">
                                    <i class="fas fa-user choice-icon"></i>
                                    <span class="choice-text">1〜2人</span>
                                    <small class="choice-desc">一人または夫婦での利用</small>
                                </div>
                            </label>
                            <label class="choice-card">
                                <input type="radio" name="hybrid_passengers" value="3-4">
                                <div class="choice-content">
                                    <i class="fas fa-user-friends choice-icon"></i>
                                    <span class="choice-text">3〜4人</span>
                                    <small class="choice-desc">小家族での利用</small>
                                </div>
                            </label>
                            <label class="choice-card">
                                <input type="radio" name="hybrid_passengers" value="5+">
                                <div class="choice-content">
                                    <i class="fas fa-users choice-icon"></i>
                                    <span class="choice-text">5人以上</span>
                                    <small class="choice-desc">大家族や多人数での利用</small>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ステップ2: 嗜好情報（5段階評価） -->
                <div class="diagnosis-step" id="diagnosis-step-2">
                    <h4 class="step-title">あなたの重視ポイントを教えてください</h4>
                    <p class="step-subtitle">各項目について、どの程度重要かを5段階で評価してください</p>

                    <div class="rating-question-group">
                        <div class="rating-question">
                            <div class="rating-header">
                                <i class="fas fa-gas-pump rating-icon"></i>
                                <div class="rating-title">燃費の良さ</div>
                            </div>
                            <div class="rating-description">燃料費を抑えたい気持ちの強さを教えてください</div>
                            <div class="rating-scale">
                                <div class="scale-labels">
                                    <span>全く重要でない</span>
                                    <span>とても重要</span>
                                </div>
                                <div class="rating-options">
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_fuel_importance" value="1">
                                        <span class="rating-number">1</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_fuel_importance" value="2">
                                        <span class="rating-number">2</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_fuel_importance" value="3">
                                        <span class="rating-number">3</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_fuel_importance" value="4">
                                        <span class="rating-number">4</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_fuel_importance" value="5">
                                        <span class="rating-number">5</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="rating-question">
                            <div class="rating-header">
                                <i class="fas fa-shield-alt rating-icon"></i>
                                <div class="rating-title">安全性</div>
                            </div>
                            <div class="rating-description">安全装備や信頼性への重要度を教えてください</div>
                            <div class="rating-scale">
                                <div class="scale-labels">
                                    <span>あまり気にしない</span>
                                    <span>最重要項目</span>
                                </div>
                                <div class="rating-options">
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_safety_importance" value="1">
                                        <span class="rating-number">1</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_safety_importance" value="2">
                                        <span class="rating-number">2</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_safety_importance" value="3">
                                        <span class="rating-number">3</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_safety_importance" value="4">
                                        <span class="rating-number">4</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_safety_importance" value="5">
                                        <span class="rating-number">5</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="rating-question">
                            <div class="rating-header">
                                <i class="fas fa-palette rating-icon"></i>
                                <div class="rating-title">デザインの良さ</div>
                            </div>
                            <div class="rating-description">見た目やスタイリングへのこだわりを教えてください</div>
                            <div class="rating-scale">
                                <div class="scale-labels">
                                    <span>機能重視</span>
                                    <span>デザイン最優先</span>
                                </div>
                                <div class="rating-options">
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_design_importance" value="1">
                                        <span class="rating-number">1</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_design_importance" value="2">
                                        <span class="rating-number">2</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_design_importance" value="3">
                                        <span class="rating-number">3</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_design_importance" value="4">
                                        <span class="rating-number">4</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_design_importance" value="5">
                                        <span class="rating-number">5</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="rating-question">
                            <div class="rating-header">
                                <i class="fas fa-expand-arrows-alt rating-icon"></i>
                                <div class="rating-title">広い室内空間</div>
                            </div>
                            <div class="rating-description">乗り心地や荷物の積みやすさを重視する度合いを教えてください</div>
                            <div class="rating-scale">
                                <div class="scale-labels">
                                    <span>コンパクトで十分</span>
                                    <span>広さ最優先</span>
                                </div>
                                <div class="rating-options">
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_space_importance" value="1">
                                        <span class="rating-number">1</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_space_importance" value="2">
                                        <span class="rating-number">2</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_space_importance" value="3">
                                        <span class="rating-number">3</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_space_importance" value="4">
                                        <span class="rating-number">4</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_space_importance" value="5">
                                        <span class="rating-number">5</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="rating-question">
                            <div class="rating-header">
                                <i class="fas fa-tools rating-icon"></i>
                                <div class="rating-title">経済的な運用</div>
                            </div>
                            <div class="rating-description">車両価格、燃料費、保険料、税金を抑えたい度合いを教えてください</div>
                            <div class="rating-scale">
                                <div class="scale-labels">
                                    <span>気にしない</span>
                                    <span>とても重要</span>
                                </div>
                                <div class="rating-options">
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_maintenance_importance" value="1">
                                        <span class="rating-number">1</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_maintenance_importance" value="2">
                                        <span class="rating-number">2</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_maintenance_importance" value="3">
                                        <span class="rating-number">3</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_maintenance_importance" value="4">
                                        <span class="rating-number">4</span>
                                    </label>
                                    <label class="rating-option">
                                        <input type="radio" name="hybrid_maintenance_importance" value="5">
                                        <span class="rating-number">5</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ステップ3: 結果表示 -->
                <div class="diagnosis-step" id="diagnosis-step-3">
                    <div class="diagnosis-results">
                        <h4 class="step-title">
                            <i class="fas fa-check-circle"></i> 診断完了！
                        </h4>

                        <div class="user-profile-result" id="userProfileResult">
                            <div class="profile-type-display">
                                <span class="profile-label">あなたのタイプ:</span>
                                <span class="profile-type-text" id="profileTypeText">分析中...</span>
                            </div>
                            <div class="profile-description-text" id="profileDescriptionText">
                                お答えいただいた内容を分析しています...
                            </div>
                            <div class="profile-recommendations" id="profileRecommendations">
                                <!-- 推薦理由がここに表示されます -->
                            </div>
                        </div>

                        <div class="diagnosis-action">
                            <button class="diagnosis-complete-button" onclick="executeHybridDiagnosis()">
                                <i class="fas fa-car"></i> あなたに最適な車を見る
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ナビゲーション -->
                <div class="diagnosis-navigation">
                    <button class="diagnosis-nav-button secondary" id="hybridPrevBtn" onclick="previousHybridStep()"
                        disabled>
                        <i class="fas fa-chevron-left"></i> 前へ
                    </button>
                    <button class="diagnosis-nav-button" id="hybridNextBtn" onclick="nextHybridStep()">
                        次へ <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- 従来の詳細検索フォーム -->
            <form method="POST" action="/" id="car-filter-form" style="display: none;">
                <!-- 既存の詳細検索フォームをそのまま維持 -->
                <div class="filter-groups">
                    <div class="filter-group">
                        <h3><i class="fas fa-truck-monster"></i> ボディタイプ</h3>
                        <p class="hint">複数選択できます</p>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="body_type" value="SUV">SUV</label>
                            <label><input type="checkbox" name="body_type" value="セダン">セダン</label>
                            <label><input type="checkbox" name="body_type" value="ハッチバック">ハッチバック</label>
                            <label><input type="checkbox" name="body_type" value="ミニバン">ミニバン</label>
                            <label><input type="checkbox" name="body_type" value="軽自動車">軽自動車</label>
                            <label><input type="checkbox" name="body_type" value="オープンカー">オープンカー</label>
                            <label><input type="checkbox" name="body_type" value="クーペ">クーペ</label>
                            <label><input type="checkbox" name="body_type" value="ハイトワゴン">ハイトワゴン</label>
                            <label><input type="checkbox" name="body_type" value="バン/トラック">バン/トラック</label>
                            <label><input type="checkbox" name="body_type" value="ワゴン">ワゴン</label>
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3><i class="fas fa-cogs"></i> 駆動方式</h3>
                        <p class="hint">複数選択できます</p>
                        <div class="checkbox-group">
                            <label title="前輪または後輪のみで駆動するオートマチックタイプ"><input type="checkbox" name="drive_type"
                                    value="2WD">2WD</label>
                            <label title="前輪または後輪のみで駆動するマニュアルタイプ"><input type="checkbox" name="drive_type"
                                    value="2WD(MT)">2WD(MT)</label>
                            <label title="全ての車輪で駆動し、悪路や雪道に強いタイプ"><input type="checkbox" name="drive_type"
                                    value="4WD">4WD</label>
                            <label title="全ての車輪で駆動し、悪路や雪道に強いマニュアルタイプ"><input type="checkbox" name="drive_type"
                                    value="4WD(MT)">4WD(MT)</label>
                            <label title="全ての車輪で駆動し、悪路や雪道に強い4段マニュアルタイプ"><input type="checkbox" name="drive_type"
                                    value="4WD(4MT)">4WD(4MT)</label>
                            <label title="全ての車輪で駆動し、悪路や雪道に強い5段マニュアルタイプ"><input type="checkbox" name="drive_type"
                                    value="4WD(5MT)">4WD(5MT)</label>
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3><i class="fas fa-gas-pump"></i> 燃料タイプ</h3>
                        <p class="hint">複数選択できます</p>
                        <div class="checkbox-group">
                            <label title="一般的な内燃機関車"><input type="checkbox" name="fuel_type" value="レギュラー">レギュラー</label>
                            <label title="一般的な内燃機関車"><input type="checkbox" name="fuel_type" value="ハイオク">ハイオク</label>
                            <label title="一般的な内燃機関車"><input type="checkbox" name="fuel_type" value="ディーゼル">ディーゼル</label>
                            <label title="水素で走る環境に優しい車"><input type="checkbox" name="fuel_type" value="水素">水素</label>
                            <label title="電気で走る環境に優しい車"><input type="checkbox" name="fuel_type"
                                    value="電気(BEV)">電気(BEV)</label>
                            <label title="エンジンと電気モーターを組み合わせた省燃費車"><input type="checkbox" name="fuel_type"
                                    value="レギュラー(HEV)">レギュラー(HEV)</label>
                            <label title="家庭用電源でも充電できるハイブリッド車"><input type="checkbox" name="fuel_type"
                                    value="レギュラー(PHEV)">レギュラー(PHEV)</label>
                            <label title="エンジンと電気モーターを組み合わせた省燃費車"><input type="checkbox" name="fuel_type"
                                    value="ハイオク(HEV)">ハイオク(HEV)</label>
                            <label title="家庭用電源でも充電できるハイブリッド車"><input type="checkbox" name="fuel_type"
                                    value="ハイオク(PHEV)">ハイオク(PHEV)</label>
                            <label title="エンジンと電気モーターを組み合わせた省燃費車"><input type="checkbox" name="fuel_type"
                                    value="ディーゼル(HEV)">ディーゼル(HEV)</label>
                            <label title="家庭用電源でも充電できるハイブリッド車"><input type="checkbox" name="fuel_type"
                                    value="ディーゼル(PHEV)">ディーゼル(PHEV)</label>
                        </div>
                    </div>
                </div>

                <div class="filter-groups">
                    <div class="filter-group">
                        <h3><i class="fas fa-yen-sign"></i> 価格帯</h3>
                        <div class="input-with-label">
                            <label for="max-price">上限</label>
                            <input type="number" id="max-price" name="max_price" placeholder="例: 3000000" min="500000"
                                max="20000000" step="100000">
                            <span class="input-hint">※500,000〜20,000,000円の範囲で設定できます</span>
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3><i class="fas fa-tachometer-alt"></i> 燃費</h3>
                        <div class="input-with-label">
                            <label for="min-fuel-economy">下限（km/L）</label>
                            <input type="number" id="min-fuel-economy" name="min_fuel_economy" placeholder="例: 15"
                                min="5" max="40" step="0.5">
                            <span class="input-hint">※5〜40km/Lの範囲で設定できます</span>
                            <!-- 電気と水素のスケールは100~200で設定できるように別の項目を作りたい -->
                        </div>
                    </div>

                    <div class="filter-group">
                        <h3><i class="fas fa-users"></i> 乗車定員</h3>
                        <div class="input-with-label">
                            <label for="min-seats">下限（人）</label>
                            <input type="number" id="min-seats" name="min_seats" placeholder="例: 5" min="2" max="14"
                                step="1">
                            <span class="input-hint">※2〜14人の範囲で設定できます</span>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="search-button"><i class="fas fa-search"></i> 車を診断する</button>
                    <button type="reset" class="reset-button"><i class="fas fa-redo"></i> リセット</button>
                </div>
            </form>

            <!-- モード切り替えボタン -->
            <div class="mode-toggle-section">
                <button type="button" class="mode-toggle-button" onclick="toggleSearchMode()">
                    <i class="fas fa-sliders-h"></i> 詳細検索に切り替え
                </button>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>AI が最適な車を診断中...</p>
        </div>

        <!-- 推薦結果の洞察表示 -->
        {% if cars and show_recommendation_details %}
        <div class="recommendation-insights">
            <h3><i class="fas fa-lightbulb"></i> AI分析結果</h3>
            <div class="insights-grid">
                <div class="insight-card">
                    <h4>検索結果</h4>
                    <p class="profile-type">{{ cars|length }}台</p>
                    <small>条件に合致した車両数</small>
                </div>
                <div class="insight-card">
                    <h4>おすすめの理由</h4>
                    {% if cars[0].get('推薦理由') %}
                    <p style="font-size: 0.9rem;">{{ cars[0]['推薦理由'] }}</p>
                    {% else %}
                    <p style="font-size: 0.9rem;">総合的な評価に基づいて選出されました</p>
                    {% endif %}
                </div>
                <div class="insight-card">
                    <h4>平均予算</h4>
                    {% set price_sum = 0 %}
                    {% set price_count = 0 %}
                    {% for car in cars[:3] %}
                    {% if car['価格帯(万円)'] and '~' in car['価格帯(万円)'] %}
                    {% set min_price = car['価格帯(万円)'].split('~')[0]|float %}
                    {% set price_sum = price_sum + min_price %}
                    {% set price_count = price_count + 1 %}
                    {% endif %}
                    {% endfor %}
                    {% if price_count > 0 %}
                    {% set avg_price = (price_sum / price_count)|round|int %}
                    <p class="budget-info">{{ avg_price }}万円〜</p>
                    {% else %}
                    <p class="budget-info">価格未定</p>
                    {% endif %}
                    <small>上位3台の平均価格（下限値）</small>
                </div>
            </div>
        </div>
        {% endif %}


        <!-- 検索結果セクション（検索実行後のみ表示） -->
        <div class="results-section" id="results" style="display: {% if cars %}block{% else %}none{% endif %};">
            <div class="result-header">
                <h2><i class="fas fa-list"></i> <span id="result-title">検索結果</span> <span class="result-count"
                        id="result-count-display">{% if cars %}({{ cars|length }}台){% endif %}</span></h2>
                <div class="sort-options">
                    <label for="sort-select">並び替え:</label>
                    <select id="sort-select" class="sort-select">
                        <option value="price-asc">価格: 安い順</option>
                        <option value="price-desc">価格: 高い順</option>
                        <option value="fuel-desc">燃費: 良い順</option>
                    </select>
                </div>
            </div>


            <div class="car-cards" id="car-results">
                {% if cars %}
                <!-- 既存の車両カード表示ロジック -->
                {% for car in cars %}
                <div class="car-card" data-price="{{ car['価格帯(万円)'] }}" data-fuel="{{ car['燃費(km/L)'] }}"
                    data-score="{{ car.get('推薦スコア', 0) }}">
                    <div class="car-header">
                        <h3>{{ car['メーカー'] }} {{ car['車種'] }}</h3>
                        <div class="score-badge" {% if not car.get('推薦スコア') %}style="display:none;" {% endif %}>
                            <span class="score-value">{{ car.get('推薦スコア', '') }}</span>
                            <span class="score-label">点</span>
                        </div>
                    </div>

                    <div class="car-body">
                        <div class="car-info">
                            <div class="info-row">
                                <div class="info-item">
                                    <span class="label"><i class="fas fa-car-side"></i> タイプ:</span>
                                    <span class="value">{{ car['ボディタイプ'] }}</span>
                                </div>
                                <div class="info-item">
                                    <span class="label"><i class="fas fa-cog"></i> 駆動:</span>
                                    <span class="value">{{ car['駆動方式'] }}</span>
                                </div>
                            </div>

                            <div class="info-row">
                                <div class="info-item">
                                    <span class="label"><i class="fas fa-yen-sign"></i> 価格帯:</span>
                                    <span class="value highlight">{{ format_currency(car['価格帯(万円)']) }}万円</span>
                                </div>
                                {% if car['燃費(km/L)'] %}
                                <div class="info-item">
                                    <span class="label"><i class="fas fa-gas-pump"></i> 燃費:</span>
                                    <span class="value">{{ car['燃費(km/L)'] }}km/L</span>
                                </div>
                                {% endif %}
                            </div>

                            <div class="info-row">
                                {% if car['燃料の種類'] %}
                                <div class="info-item">
                                    <span class="label"><i class="fas fa-battery-half"></i> 燃料:</span>
                                    <span class="value fuel-type-{{ car['燃料の種類'] }}">{{ car['燃料の種類'] }}</span>
                                </div>
                                {% endif %}
                                {% if car['乗車定員'] %}
                                <div class="info-item">
                                    <span class="label"><i class="fas fa-users"></i> 定員:</span>
                                    <span class="value">{{ car['乗車定員'] }}人</span>
                                </div>
                                {% endif %}
                            </div>

                            {% if car['サイズ(mm)'] %}
                            <div class="info-row">
                                <div class="info-item full-width">
                                    <span class="label"><i class="fas fa-ruler-combined"></i> サイズ:</span>
                                    <span class="value">{{ car['サイズ(mm)'] }}</span>
                                </div>
                            </div>
                            {% endif %}

                            {% if car['中古相場(万円)'] %}
                            <div class="info-row">
                                <div class="info-item">
                                    <span class="label"><i class="fas fa-recycle"></i> 中古相場:</span>
                                    <span class="value">{{ car['中古相場(万円)'] }}万円</span>
                                </div>
                                {% if car.get('自動車税(円)') %}
                                <div class="info-item">
                                    <span class="label"><i class="fas fa-receipt"></i> 税金:</span>
                                    <span class="value">{{ "{:,}".format(car['自動車税(円)']|int) }}円/年</span>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}

                            {% if car.youtube_thumbnail %}
                            <a href="/car/{{ car['id'] }}?tab=reviews" class="card-video-thumbnail">
                                <img src="{{ car.youtube_thumbnail }}" alt="{{ car['メーカー'] }} {{ car['車種'] }} レビュー動画">
                                <div class="video-play-badge"><i class="fab fa-youtube"></i> 動画</div>
                            </a>
                            {% endif %}
                        </div>

                        <div class="car-actions">
                            <a href="/car/{{ car['id'] }}" class="action-button"><i
                                    class="fas fa-info-circle"></i>詳細</a>
                            {% if car.youtube_url %}
                            <a href="/car/{{ car['id'] }}?tab=reviews" class="action-button youtube-button">
                                <i class="fab fa-youtube"></i> 動画
                            </a>
                            {% endif %}
                            <button class="action-button secondary favorite-button" data-car-id="{{ car['id'] }}">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>

            <div class="pagination" id="pagination-container" style="display: none;">
                <button class="pagination-button" id="prev-page" disabled><i class="fas fa-chevron-left"></i>
                    前へ</button>
                <span class="page-indicator" id="page-info">1 / 1</span>
                <button class="pagination-button" id="next-page" disabled>次へ <i
                        class="fas fa-chevron-right"></i></button>
            </div>

            <div id="no-results-message" class="no-results"
                style="display: {% if not cars %}flex{% else %}none{% endif %};">
                <i class="fas fa-exclamation-circle"></i>
                <p>条件に合う車が見つかりませんでした。条件を変更して再検索してください。</p>
                <button class="reset-filters-button"
                    onclick="document.getElementById('car-filter-form').reset(); executeSearch(1);">
                    <i class="fas fa-redo"></i> 検索条件をリセット
                </button>
            </div>
        </div>

        <footer>
            <div class="footer-content">
                <div class="footer-section">
                    <h3>AI自動車診断について</h3>
                    <p>当サイトは車選びをAIでサポートする無料サービスです。</p>
                </div>
                <div class="footer-section">
                    <h3>お問い合わせ</h3>
                    <p><i class="fas fa-envelope"></i> info@example.com</p>
                </div>
                <div class="footer-section">
                    <h3>フォローする</h3>
                    <div class="social-links">
                        <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-facebook"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 AI自動車診断 - あなたに最適な車を見つけよう</p>
            </div>
        </footer>

        <!-- JavaScript読み込み -->
        <script src="{{ url_for('static', filename='js/script.js') }}"></script>
        <script src="{{ url_for('static', filename='js/enhanced.js') }}"></script>
        <script src="{{ url_for('static', filename='js/hybrid.js') }}"></script>
</body>

</html>